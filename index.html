<!doctype html>
<html lang="zh-TW">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>自動跳轉頁面</title>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-H4MFYVE6VD"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-H4MFYVE6VD');
    </script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        html {
            height: 100%;
        }

        .container {
            text-align: center;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 90%;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 2rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .message {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
            line-height: 1.6;
        }

        .countdown {
            font-size: 3rem;
            font-weight: bold;
            color: #ffd700;
            margin: 2rem 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .url-display {
            background: rgba(255, 255, 255, 0.2);
            padding: 1rem;
            border-radius: 10px;
            margin: 1.5rem 0;
            font-family: 'Courier New', monospace;
            word-break: break-all;
            font-size: 0.9rem;
        }

        .controls {
            margin-top: 2rem;
        }

        .btn {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            border: none;
            padding: 0.8rem 2rem;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            margin: 0 0.5rem;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(66, 153, 225, 0.4);
            background: linear-gradient(135deg, #3182ce, #2c5282);
        }

        .btn-cancel {
            background: linear-gradient(135deg, #e53e3e, #c53030);
        }

        .btn-cancel:hover {
            background: linear-gradient(135deg, #c53030, #9c2626);
            box-shadow: 0 6px 20px rgba(229, 62, 62, 0.4);
        }

        .status {
            margin-top: 1rem;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 2rem;
                margin: 1rem;
            }
            
            .title {
                font-size: 2rem;
            }
            
            .countdown {
                font-size: 2.5rem;
            }
            
            .btn {
                display: block;
                margin: 0.5rem auto;
                width: 200px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <main class="container">
   <h1 class="title" id="page-title">頁面跳轉中</h1>
   <p class="message" id="loading-message">正在為您跳轉到目標頁面...</p>
   <div class="loading-spinner"></div>
   <div class="countdown" id="countdown">
    3
   </div>
   <div class="url-display" id="url-display">
    https://kabc.youc.eu.org
   </div>
   <div class="controls"><button class="btn" id="redirect-now" onclick="redirectNow()">立即跳轉</button> <button class="btn btn-cancel" id="cancel-redirect" onclick="cancelRedirect()">取消跳轉</button>
   </div>
   <div class="status" id="status">
    自動跳轉將在倒數結束後執行
   </div>
  </main>
  <script>
        // let redirectTimer = null; // <-- 移除
        let countdownTimer = null;
        let currentCountdown = 3;
        let isRedirecting = false;

        const defaultConfig = {
            target_url: "https://kabc.youc.eu.org",
            delay_seconds: "3",
            page_title: "頁面跳轉中",
            loading_message: "正在為您跳轉到目標頁面...",
            background_color: "#667eea",
            primary_color: "#4299e1",
            text_color: "#ffffff",
            accent_color: "#ffd700",
            card_color: "#ffffff",
            font_family: "Microsoft JhengHei",
            font_size: 16
        };

        function startRedirect() {
            const targetUrl = (window.elementSdk?.config?.target_url || defaultConfig.target_url).trim();
            const delaySeconds = parseInt(window.elementSdk?.config?.delay_seconds || defaultConfig.delay_seconds) || 3;
            
            if (!targetUrl) {
                document.getElementById('status').textContent = '請設定目標網址';
                return;
            }

            // Validate URL
            if (!targetUrl.startsWith('http://') && !targetUrl.startsWith('https://')) {
                document.getElementById('status').textContent = '網址格式錯誤，請使用 http:// 或 https:// 開頭';
                return;
            }

            // 確保每次開始跳轉時，轉圈動畫都會顯示
            const loadingSpinner = document.querySelector('.loading-spinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'block'; 
            }

            currentCountdown = delaySeconds;
            document.getElementById('countdown').textContent = currentCountdown;
            document.getElementById('url-display').textContent = targetUrl;
            document.getElementById('status').textContent = '自動跳轉將在倒數結束後執行';
            
            isRedirecting = true;
            
            countdownTimer = setInterval(() => {
                currentCountdown--;
                document.getElementById('countdown').textContent = currentCountdown;
                
                if (currentCountdown <= 0) {
                    clearInterval(countdownTimer);
                    executeRedirect(); // 只在這裡觸發
                }
            }, 1000);
            
            // redirectTimer = setTimeout(() => { // <-- 移除
            //     executeRedirect();
            // }, delaySeconds * 1000);
        }

        function executeRedirect() {
            if (!isRedirecting) return;
            isRedirecting = false; // 防止重複觸發
            
            const targetUrl = (window.elementSdk?.config?.target_url || defaultConfig.target_url).trim();
            document.getElementById('status').textContent = '正在跳轉...';
            
            // 隱藏轉圈動畫 (優化 2: 轉圈倒數完不會消失)
            const loadingSpinner = document.querySelector('.loading-spinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
            
            // 解決彈窗被封鎖的問題 (優化 1: 改為導航當前視窗，確保跳轉成功)
            // 原先使用 window.open 開啟新分頁在自動跳轉時會被瀏覽器封鎖。
            // 替換為 window.location.href 導航當前頁面，確保跳轉成功。
            window.location.href = targetUrl;
            
            // 由於頁面將被導航，以下狀態更新通常不會顯示，僅作為跳轉成功後顯示的預留
            document.getElementById('countdown').textContent = '✓';
            document.getElementById('countdown').style.color = '#48bb78';
            document.getElementById('status').textContent = '已開始跳轉...';
        }

        function redirectNow() {
            // if (redirectTimer) clearTimeout(redirectTimer); // <-- 移除
            if (countdownTimer) clearInterval(countdownTimer);
            executeRedirect();
        }

        function cancelRedirect() {
            // if (redirectTimer) clearTimeout(redirectTimer); // <-- 移除
            if (countdownTimer) clearInterval(countdownTimer);
            
            isRedirecting = false;
            document.getElementById('countdown').textContent = '✕';
            document.getElementById('countdown').style.color = '#e53e3e';
            document.getElementById('status').textContent = '跳轉已取消';

            // 隱藏轉圈動畫 (優化 2: 轉圈倒數完不會消失)
            const loadingSpinner = document.querySelector('.loading-spinner');
            if (loadingSpinner) {
                loadingSpinner.style.display = 'none';
            }
        }

        async function onConfigChange(config) {
            const pageTitle = document.getElementById('page-title');
            const loadingMessage = document.getElementById('loading-message');
            const urlDisplay = document.getElementById('url-display');

            if (pageTitle) {
                pageTitle.textContent = config.page_title || defaultConfig.page_title;
            }
            if (loadingMessage) {
                loadingMessage.textContent = config.loading_message || defaultConfig.loading_message;
            }
            if (urlDisplay) {
                urlDisplay.textContent = config.target_url || defaultConfig.target_url;
            }

            // Apply colors
            const backgroundColor = config.background_color || defaultConfig.background_color;
            const textColor = config.text_color || defaultConfig.text_color;
            const accentColor = config.accent_color || defaultConfig.accent_color;

            document.body.style.background = `linear-gradient(135deg, ${backgroundColor} 0%, #764ba2 100%)`;
            document.body.style.color = textColor;
            
            const countdown = document.getElementById('countdown');
            if (countdown && !countdown.textContent.includes('✓') && !countdown.textContent.includes('✕')) {
                countdown.style.color = accentColor;
            }

            // Apply font
            const customFont = config.font_family || defaultConfig.font_family;
            const baseFontStack = 'Microsoft JhengHei, PingFang TC, sans-serif';
            document.body.style.fontFamily = `${customFont}, ${baseFontStack}`;

            // Apply font size
            const baseSize = config.font_size || defaultConfig.font_size;
            document.body.style.fontSize = `${baseSize}px`;
            
            if (pageTitle) {
                pageTitle.style.fontSize = `${baseSize * 2.5}px`;
            }
            if (loadingMessage) {
                loadingMessage.style.fontSize = `${baseSize * 1.2}px`;
            }

            // Restart redirect with new settings
            // if (redirectTimer) clearTimeout(redirectTimer); // <-- 移除
            if (countdownTimer) clearInterval(countdownTimer);
            
            // Reset countdown display
            const countdownEl = document.getElementById('countdown');
            if (countdownEl) {
                countdownEl.style.color = accentColor;
            }
            
            startRedirect();
        }

        function mapToCapabilities(config) {
            return {
                recolorables: [
                    {
                        get: () => config.background_color || defaultConfig.background_color,
                        set: (value) => {
                            config.background_color = value;
                            window.elementSdk.setConfig({ background_color: value });
                        }
                    },
                    {
                        get: () => config.primary_color || defaultConfig.primary_color,
                        set: (value) => {
                            config.primary_color = value;
                            window.elementSdk.setConfig({ primary_color: value });
                        }
                    },
                    {
                        get: () => config.text_color || defaultConfig.text_color,
                        set: (value) => {
                            config.text_color = value;
                            window.elementSdk.setConfig({ text_color: value });
                        }
                    },
                    {
                        get: () => config.accent_color || defaultConfig.accent_color,
                        set: (value) => {
                            config.accent_color = value;
                            window.elementSdk.setConfig({ accent_color: value });
                        }
                    },
                    {
                        get: () => config.card_color || defaultConfig.card_color,
                        set: (value) => {
                            config.card_color = value;
                            window.elementSdk.setConfig({ card_color: value });
                        }
                    }
                ],
                borderables: [],
                fontEditable: {
                    get: () => config.font_family || defaultConfig.font_family,
                    set: (value) => {
                        config.font_family = value;
                        window.elementSdk.setConfig({ font_family: value });
                    }
                },
                fontSizeable: {
                    get: () => config.font_size || defaultConfig.font_size,
                    set: (value) => {
                        config.font_size = value;
                        window.elementSdk.setConfig({ font_size: value });
                    }
                }
            };
        }

        function mapToEditPanelValues(config) {
            return new Map([
                ["target_url", config.target_url || defaultConfig.target_url],
                ["delay_seconds", config.delay_seconds || defaultConfig.delay_seconds],
                ["page_title", config.page_title || defaultConfig.page_title],
                ["loading_message", config.loading_message || defaultConfig.loading_message]
            ]);
        }

        // Initialize the SDK
        if (window.elementSdk) {
            window.elementSdk.init({
                defaultConfig,
                onConfigChange,
                mapToCapabilities,
                mapToEditPanelValues
            });
        } else {
            // Fallback if SDK is not available
            startRedirect();
        }
    </script>
 </body>
</html>